<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video to GIF Converter</title>
    <style>
        #dropzone {
            width: 300px;
            height: 200px;
            border: 2px dashed #ccc;
            text-align: center;
            padding: 20px;
            margin: 20px auto;
        }
        #dropzone.highlight {
            border-color: purple;
        }
    </style>
</head>
<body>
    <div id="dropzone">Drag and drop video here or <label for="fileInput" style="color: blue; cursor: pointer;">click to select</label><input type="file" id="fileInput" accept="video/*" style="display: none;">
    </div>
    <a id="download" style="display:none;">Download GIF</a>
    <img id="preview" style="display:none; max-width: 100%;">
    <div id="status" style="text-align: center; margin: 10px; color: red;"></div>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
    <script>
        const ffmpegScript = document.createElement('script');
        ffmpegScript.src = 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js';
        ffmpegScript.onload = function() {
            const { createFFmpeg, fetchFile } = FFmpeg;
            const ffmpeg = createFFmpeg({
                log: true,
                corePath: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js'
            });
            let loaded = false;
            const dropzone = document.getElementById('dropzone');
            const downloadLink = document.getElementById('download');
            const preview = document.getElementById('preview');
            const status = document.getElementById('status');
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('highlight');
            });
            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('highlight');
            });
            dropzone.addEventListener('drop', async (e) => {
                e.preventDefault();
                dropzone.classList.remove('highlight');
                const file = e.dataTransfer.files[0];
                if (!file) return;
                await processFile(file);
            });

            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                await processFile(file);
            });

            async function processFile(file) {
                try {
                    status.textContent = 'Processing...';
                    status.style.color = 'blue';
                    if (!loaded) {
                        status.textContent = 'Loading FFmpeg...';
                        if (typeof FFmpeg === 'undefined') {
                            throw new Error('FFmpeg library failed to load. Please check your internet connection and try reloading the page.');
                        }
                        await ffmpeg.load();
                        loaded = true;
                    }
                    ffmpeg.FS('writeFile', file.name, await fetchFile(file));
                    await ffmpeg.run('-i', file.name, '-vf', 'fps=10,scale=640:-1:flags=lanczos', '-loop', '0', 'out.gif');
                    const data = ffmpeg.FS('readFile', 'out.gif');
                    const url = URL.createObjectURL(new Blob([data.buffer], { type: 'image/gif' }));
                    preview.src = url;
                    preview.style.display = 'block';
                    downloadLink.href = url;
                    downloadLink.download = 'output.gif';
                    downloadLink.textContent = 'Download GIF';
                    downloadLink.style.display = 'block';
                    status.textContent = 'Conversion successful!';
                    status.style.color = 'green';
                } catch (error) {
                    console.error(error);
                    status.textContent = `Error: ${error.message}`;
                    status.style.color = 'red';
                } finally {
                    dropzone.innerHTML = 'Drag and drop video here or <label for="fileInput" style="color: blue; cursor: pointer;">click to select</label><input type="file" id="fileInput" accept="video/*" style="display: none;">';
                }
            }
        };
        document.head.appendChild(ffmpegScript);
    </script>
</body>
</html>
